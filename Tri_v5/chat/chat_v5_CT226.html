<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤© - æ™ºèƒ½åŠ©æ‰‹</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
        }
        body {
            width: 100vw;
            min-height: 100dvh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100dvh;
            min-height: 0;
            background: rgba(34, 40, 49, 0.98);
            border-radius: 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            overflow: hidden;
            border: 1.5px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(4px);
            box-sizing: border-box;
            padding-top: env(safe-area-inset-top);
            position: relative;
        }
        .header {
            width: 100%;
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            color: white;
            text-align: center;
            padding: 20px 0 16px 0;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chat-box {
            flex: 1 1 0;
            min-height: 0;
            width: 100%;
            background: transparent;
            padding: 18px 16px 8px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            border-bottom: 1px solid #2d3748;
            transition: background 0.3s;
            padding-bottom: 20px;
        }
        .message {
            padding: 14px 18px;
            border-radius: 18px 18px 18px 6px;
            max-width: 80%;
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-line;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s forwards;
            margin: 0 12px;
        }
        .message.bot {
            background: linear-gradient(90deg, #555 0%, #607d8b 100%);
            color: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message.user {
            background: linear-gradient(90deg, #00bcd4 0%, #2196f3 100%);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .button-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px 16px 10px 16px;
            width: 100%;
            background: transparent;
            border-bottom: none;
            margin: 0;
            box-sizing: border-box;
        }
        .button-container button {
            width: 100%;
            height: 112px;
            padding: 0;
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            border: none;
            font-size: 18px;
            cursor: pointer;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,188,212,0.10);
            transition: background 0.3s, transform 0.2s;
        }
        .button-container button:hover {
            background: linear-gradient(90deg, #078282 0%, #12214e 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .input-area {
            width: 100%;
            background: #23272f;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 10px;
            border-top: 1px solid #2d3748;
            /* position: fixed; */
            /* bottom: 95px; */
            /* left: 0; */
            /* right: 0; */
            max-width: 420px;
            margin: 0 auto;
            box-sizing: border-box;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .input-area input {
            flex: 1;
            background: #181c22;
            border: none;
            border-radius: 8px;
            padding: 12px 14px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: background 0.2s;
        }
        .input-area input:focus {
            background: #23272f;
        }
        .input-area button {
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 18px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        .input-area button:hover {
            background: linear-gradient(90deg, #078282 0%, #12214e 100%);
            transform: scale(1.05);
        }
        .button-row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 12px;
            padding: 0 16px 10px 16px;
            width: 100%;
            background: transparent;
            border-bottom: none;
            margin: 0;
            box-sizing: border-box;
            /* margin-bottom: 150px; */
        }
        .button-row button {
            flex: 1 1 0;
            aspect-ratio: 1 / 1;
            width: 100%;
            height: auto;
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            border: none;
            font-size: 18px;
            cursor: pointer;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,188,212,0.10);
            transition: background 0.3s, transform 0.2s;
            margin: 0;
        }
        .button-row button:hover {
            background: linear-gradient(90deg, #078282 0%, #12214e 100%);
            transform: translateY(-2px) scale(1.04);
        }
        .nav-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(34, 40, 49, 0.98);
            border-top: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(4px);
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #b0bec5;
            text-decoration: none;
            font-size: 12px;
            padding: 8px;
            transition: color 0.3s;
            flex: 1;
            text-align: center;
            position: relative;
        }
        .nav-button.active {
            color: #00bcd4;
        }
        .nav-button img {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        /* èŠå¤©æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
        .nav-button[href*="chat"] {
            position: relative;
            margin-top: 0;
            min-height: 54px;
        }
        .nav-button[href*="chat"] img {
            position: absolute;
            top: -18px;
     
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #00bcd4 0%, #2196f3 100%);
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,188,212,0.3),
                        inset 0 -2px 6px rgba(0,0,0,0.2),
                        inset 0 2px 6px rgba(255,255,255,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .nav-button[href*="chat"]:hover img {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0,188,212,0.4),
                        inset 0 -2px 6px rgba(0,0,0,0.2),
                        inset 0 2px 6px rgba(255,255,255,0.2);
        }
        .nav-button span {
            position: absolute;
            bottom: 8px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
        }
        .nav-button:hover span,
        .nav-button.active span {
            color: #00bcd4;
        }
        .nav-button[href*="chat"] span {
            font-weight: 600;
        }
        @media (max-width: 500px) {
            .chat-container {
                max-width: 100vw;
                height: 100dvh;
                min-height: 0;
                border-radius: 0;
                padding-bottom: 95px;
            }
            .chat-box {
                padding: 10px 4vw 8px 4vw;
            }
            .button-container, .input-area {
                padding-left: 16px;
                padding-right: 16px;
            }
            .nav-buttons {
                max-width: 100vw;
                border-radius: 0;
            }
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background: rgba(0,188,212,0.3);
            border-radius: 4px;
        }
        .chat-box::-webkit-scrollbar-thumb:hover {
            background: rgba(0,188,212,0.5);
        }
        /* Firefox æ»¾å‹•æ¢æ¨£å¼ */
        .chat-box {
            scrollbar-width: thin;
            scrollbar-color: rgba(0,188,212,0.3) rgba(255,255,255,0.05);
        }
        /* èª²è¡¨æŒ‰éˆ•ï¼ˆä¸»è‰²ï¼‰ */
        .button-container button {
            background: linear-gradient(90deg, #12214e 0%, #078282 100%);
            color: #fff;
        }
        /* æ¸¸æ³³ */
        #swimming-button {
            background: linear-gradient(90deg, #003d4d 0%, #0b5a6f 100%);
            color: #fff;
        }
        /* é¨è»Š */
        #cycling-button {
            background: linear-gradient(90deg, #0b5a6f 0%, #1c8b93 100%);
            color: #fff;
        }
        /* è·‘æ­¥ */
        #running-button {
            background: linear-gradient(90deg, #1c8b93 0%, #3ab1b6 100%);
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <span>æˆ‘çš„èª²è¡¨</span>
        </div>
        <div class="chat-box" id="chat-box"></div>
        <div class="button-container">
            <button id="daily-schedule-button">
                <img src="../images/schedule_today.png" alt="ä»Šæ—¥èª²è¡¨" style="width:60px;height:60px;display:block;margin:0 auto 2px auto;" />
                <span style="font-size:14px;">ä»Šæ—¥èª²è¡¨</span>
            </button>
            <button id="weekly-schedule-button">
                <img src="../images/schedule_week.png" alt="æœ¬é€±èª²è¡¨" style="width:60px;height:60px;display:block;margin:0 auto 2px auto;" />
                <span style="font-size:14px;">æœ¬é€±èª²è¡¨</span>
            </button>
        </div>
        <div class="button-row">
            <button id="swimming-button">
                <img src="../images/swim.png" alt="æ¸¸æ³³" style="width:60px;height:60px;display:block;margin:0 auto 2px auto;" />
                <span style="font-size:14px;">ä»Šå¤©æ¸¸äº†</span>
            </button>
            <button id="cycling-button">
                <img src="../images/bike.png" alt="é¨è»Š" style="width:67px;height:67px;display:block;margin:0 auto -7px auto;" />
                <span style="font-size:14px;">ä»Šå¤©é¨äº†</span>
            </button>
            <button id="running-button">
                <img src="../images/run.png" alt="è·‘æ­¥" style="width:45px;height:45px;display:block;margin:0 auto 16px auto;" />
                <span style="font-size:14px;">ä»Šå¤©è·‘äº†</span>
            </button>
        </div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="ä½ ä»Šå¤©é‹å‹•äº†å—?">
            <button id="send-button">â¤</button>
        </div>
        <div class="nav-buttons">
            <a href="../index.html" class="nav-button">
                <img src="../images/home.svg" alt="é¦–é ">
                <span>é¦–é </span>
            </a>
            <a href="../stats.html" class="nav-button">
                <img src="../images/stats.svg" alt="çµ±è¨ˆ">
                <span>çµ±è¨ˆ</span>
            </a>
            <a href="../chat/chat_v5_CT226.html" class="nav-button active">
                <img src="../images/chat.svg" alt="èŠå¤©">
                <span>èŠå¤©</span>
            </a>
            <a href="../clendar/clendar.html" class="nav-button">
                <img src="../images/calendar.svg" alt="æ—¥æ›†">
                <span>æ—¥æ›†</span>
            </a>
            <a href="../membership/membership.html" class="nav-button">
                <img src="../images/user.svg" alt="æœƒå“¡">
                <span>æœƒå“¡</span>
            </a>
        </div>
    </div>

    <!-- ç™»å…¥/è¨»å†Š Modal -->
    <div id="auth-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:12px; padding:32px 24px; max-width:320px; margin:auto; box-shadow:0 4px 24px rgba(0,0,0,0.18);">
            <h2 style="margin-top:0;">ç™»å…¥ / è¨»å†Š</h2>
            <input id="auth-username" type="text" placeholder="å¸³è™Ÿ" style="width:100%;margin-bottom:12px;padding:8px;">
            <input id="auth-password" type="password" placeholder="å¯†ç¢¼" style="width:100%;margin-bottom:12px;padding:8px;">
            <div style="display:flex;gap:8px;">
                <button id="login-btn" style="flex:1;">ç™»å…¥</button>
                <button id="register-btn" style="flex:1;">è¨»å†Š</button>
            </div>
            <div id="auth-error" style="color:red;margin-top:10px;min-height:20px;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatBox = document.getElementById('chat-box');
            const schedule_226 = [
                // ç¬¬1é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘6 k',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85Kï¼Œå†è·‘3 Kã€‚',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬2é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘5Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘5Kã€‚'
                },
                // ç¬¬3é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘3 Kã€‚',
                    'Wednesday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘3 Kã€‚',
                    'Thursday': 'è·‘7 K',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚',
                    'Sunday': 'è·‘15 K'
                },
                // ç¬¬4é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ”¾å‡',
                    'Wednesday': 'æ¸¸2K',
                    'Thursday': 'è¨“ç·´å°60åˆ†',
                    'Friday': 'æ”¾å‡',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚'
                },
                // ç¬¬5é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ”¾å‡',
                    'Wednesday': 'æ¸¸2K',
                    'Thursday': 'è¨“ç·´å°60åˆ†',
                    'Friday': 'è·‘10 K',
                    'Saturday': 'æ”¾å‡',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚'
                },
                // ç¬¬6é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚'
                },
                // ç¬¬7é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è¨“ç·´å°70åˆ†',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬8é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è·‘10 K',
                    'Thursday': 'è¨“ç·´å°70åˆ†',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨75Kï¼Œå†è·‘3Kã€‚',
                    'Sunday': 'è¨“ç·´å°30åˆ†ï¼Œå†è·‘10Kã€‚'
                },
                // ç¬¬9é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è¨“ç·´å°60åˆ†',
                    'Friday': 'æ”¾å‡',
                    'Saturday': 'è¨“ç·´å°30åˆ†ï¼Œå†è·‘10Kã€‚',
                    'Sunday': 'è¨“ç·´å°30åˆ†ï¼Œå†è·‘10Kã€‚'
                },
                // ç¬¬10é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘10 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨40Kï¼Œå†è·‘10Kã€‚',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬11é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨40Kï¼Œå†è·‘10Kã€‚',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬12é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸2.5K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨70Kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬13é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸1.5K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘8 K',
                    'Friday': 'æ¸¸2 K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85K',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬14é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85K',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨85K'
                },
                // ç¬¬15é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3K',
                    'Wednesday': 'è¨“ç·´å°70åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85K',
                    'Sunday': 'è·‘12 K'
                },
                // ç¬¬16é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85Kã€‚',
                    'Sunday': 'è·‘15 k'
                },
                // ç¬¬17é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨85Kã€‚',
                    'Sunday': 'è·‘15 k'
                },
                // ç¬¬18é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'æ”¾å‡',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'è·‘12 K',
                    'Saturday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚',
                    'Sunday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚'
                },
                // ç¬¬19é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘10 K',
                    'Friday': 'æ”¾å‡',
                    'Saturday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚',
                    'Sunday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚'
                },
                // ç¬¬20é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'è·‘12 K',
                    'Saturday': 'è¨“ç·´å°70åˆ†ï¼Œå†è·‘10 Kã€‚',
                    'Sunday': 'è¨“ç·´å°70åˆ†ï¼Œå†è·‘10 Kã€‚'
                },
                // ç¬¬21é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'è·‘12 K',
                    'Saturday': 'è·‘12 K',
                    'Sunday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚'
                },
                // ç¬¬22é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘12 K',
                    'Friday': 'è¨“ç·´å°90åˆ†',
                    'Saturday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚',
                    'Sunday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚'
                },
                // ç¬¬23é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è¨“ç·´å°60åˆ†ï¼Œå†è·‘10 Kã€‚',
                    'Friday': 'æ¸¸3K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚'
                },
                // ç¬¬24é€±
                {
                    'Monday': 'æ”¾å‡ã€‚',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'è¨“ç·´å°90åˆ†',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚'
                },
                // ç¬¬25é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘12K',
                    'Friday': 'è·‘12K',
                    'Saturday': 'è¨“ç·´å°90åˆ†ï¼Œå†è·‘6Kã€‚',
                    'Sunday': 'è¨“ç·´å°90åˆ†ï¼Œå†è·‘6Kã€‚'
                },
                // ç¬¬26é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3.8K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘10 K',
                    'Friday': 'æ¸¸3.8K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'è¨“ç·´å°90åˆ†ï¼Œå†è·‘10 k'
                },
                // ç¬¬27é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3K',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘10 K',
                    'Friday': 'æ¸¸2.5K',
                    'Saturday': 'è¨“ç·´å°90åˆ†ï¼Œå†è·‘6Kã€‚',
                    'Sunday': 'è¨“ç·´å°90åˆ†ï¼Œå†è·‘6Kã€‚'
                },
                // ç¬¬28é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'è¨“ç·´å°60åˆ†',
                    'Wednesday': 'è¨“ç·´å°60åˆ†',
                    'Thursday': 'è·‘10 K',
                    'Friday': 'æ¸¸3K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚'
                },
                // ç¬¬29é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'è¨“ç·´å°60åˆ†',
                    'Wednesday': 'è·‘10 K',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'æ¸¸2K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'è·‘15K'
                },
                // ç¬¬30é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'è¨“ç·´å°60åˆ†',
                    'Wednesday': 'è·‘10 K',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'æ¸¸3K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'è·‘18K'
                },
                // ç¬¬31é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'è¨“ç·´å°90åˆ†',
                    'Wednesday': 'è·‘13K',
                    'Thursday': 'è¨“ç·´å°90åˆ†',
                    'Friday': 'æ¸¸3K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'è·‘18K'
                },
                // ç¬¬32é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘15K',
                    'Friday': 'è¨“ç·´å°90åˆ†',
                    'Saturday': 'æ¸¸3.8K',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚'
                },
                // ç¬¬33é€±
                {
                    'Monday': 'æ”¾å‡',
                    'Tuesday': 'æ¸¸3K',
                    'Wednesday': 'è¨“ç·´å°90åˆ†',
                    'Thursday': 'è·‘15K',
                    'Friday': 'æ¸¸3.8K',
                    'Saturday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚',
                    'Sunday': 'æ°´æœˆå…¬åœ’åœ˜é¨86 kï¼Œå†è·‘5 Kã€‚'
                },
                // ç¬¬34é€±
                {
                    'Monday': 'æ¸¸3.8K',
                    'Tuesday': 'è¨“ç·´å°60åˆ†',
                    'Wednesday': 'è·‘10Kï¼ˆæ—©ä¸Šä¸ƒé»å‰è¦å®Œæˆã€‚ï¼‰',
                    'Thursday': 'æ”¾å‡',
                    'Friday': 'æ”¾å‡',
                    'Saturday': 'CT226',
                    'Sunday': 'æ”¾å‡'
                }
            ];

            const dailyScheduleButton = document.getElementById('daily-schedule-button');
            const weeklyScheduleButton = document.getElementById('weekly-schedule-button');
            const swimmingButton = document.getElementById('swimming-button');
            const cyclingButton = document.getElementById('cycling-button');
            const runningButton = document.getElementById('running-button');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

            // å–å¾—ç›®å‰ç™»å…¥ç”¨æˆ¶
            function getCurrentUser() {
                return localStorage.getItem('currentUser');
            }

            // ç²å–ç”¨æˆ¶æ•¸æ“š
            function getUserData() {
                const currentUser = getCurrentUser();
                const userData = JSON.parse(localStorage.getItem(`user_${currentUser}`)) || {
                    chatHistory: [],
                    calendarEvents: {}
                };
                return userData;
            }

            function getCurrentWeekIndex() {
                const currentDate = new Date();
                const startDate = new Date(currentDate.getFullYear(), 0, 1);
                const days = Math.floor((currentDate - startDate) / (24 * 60 * 60 * 1000));
                const weekNumber = Math.ceil((days + startDate.getDay() + 1) / 7);
                return (weekNumber - 1) % schedule_226.length;
            }

            function getTodaySchedule() {
                // å–å¾—æœ¬é€±èª²è¡¨
                const currentWeekIndex = getCurrentWeekIndex();
                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const todayDate = new Date();
                const todayIdx = todayDate.getDay() === 0 ? 6 : todayDate.getDay() - 1; // 0=Sunday
                // å–å¾—æœ¬é€±çš„æ—¥æœŸå­—ä¸²
                const weekStart = new Date(todayDate);
                weekStart.setDate(todayDate.getDate() - todayDate.getDay() + 1); // é€±ä¸€
                let weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    weekDates.push(d);
                }
                // å–å¾—calendarEvents
                const currentUser = getCurrentUser();
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                // å…ˆè¤‡è£½åŸå§‹èª²è¡¨
                let schedule = {...schedule_226[currentWeekIndex]};
                // å…ˆæ¨™è¨˜æ‰€æœ‰Eventç•¶å¤©åŠå‰2å¤©
                let eventDays = [];
                weekDates.forEach((date, idx) => {
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    if (events[dateKey] && events[dateKey].some(ev => ev.type === 'Event')) {
                        eventDays.push(idx);
                    }
                });
                if (eventDays.length > 0) {
                    // è¨­å®šæ”¾å‡èˆ‡Eventé¡¯ç¤ºï¼ˆé€£çºŒEventä¸è¦†è“‹Eventç•¶å¤©ï¼‰
                    eventDays.forEach(idx => {
                        for (let i = 1; i <= 2; i++) {
                            const restIdx = idx - i;
                            if (restIdx >= 0 && !eventDays.includes(restIdx)) {
                                schedule[daysOfWeek[restIdx]] = 'æ”¾å‡';
                            }
                        }
                        const date = weekDates[idx];
                        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const eventList = (events[dateKey] || []).filter(ev => ev.type === 'Event');
                        if (eventList.length > 0) {
                            schedule[daysOfWeek[idx]] = eventList.map(ev => {
                                let str = ev.name || 'è³½äº‹';
                                if (ev.distance) str += ` ${ev.distance}K`;
                                return str;
                            }).join(' / ');
                        }
                    });
                }
                // å¯«å…¥ localStorage ä¾›é¦–é åŒæ­¥
                try { localStorage.setItem('todaySchedule', schedule[daysOfWeek[todayIdx]]); } catch(e){}
                return schedule[daysOfWeek[todayIdx]] || 'No training today.';
            }

            function getWeeklySchedule() {
                const currentWeekIndex = getCurrentWeekIndex();
                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                // å–å¾—æœ¬é€±çš„æ—¥æœŸå­—ä¸²
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1); // é€±ä¸€
                let weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(weekStart);
                    d.setDate(weekStart.getDate() + i);
                    weekDates.push(d);
                }
                // å–å¾—calendarEvents
                const currentUser = getCurrentUser();
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                // å…ˆè¤‡è£½åŸå§‹èª²è¡¨
                let schedule = {...schedule_226[currentWeekIndex]};
                // å…ˆæ¨™è¨˜æ‰€æœ‰Eventç•¶å¤©åŠå‰2å¤©
                let eventDays = [];
                weekDates.forEach((date, idx) => {
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    if (events[dateKey] && events[dateKey].some(ev => ev.type === 'Event')) {
                        eventDays.push(idx);
                    }
                });
                if (eventDays.length === 0) {
                    // æ²’æœ‰ä»»ä½•Eventï¼Œç›´æ¥å›å‚³åŸå§‹èª²è¡¨
                    return daysOfWeek.map(day => `${day}: ${schedule[day] || 'No training'}`).join('\n');
                }
                // è¨­å®šæ”¾å‡èˆ‡Eventé¡¯ç¤ºï¼ˆé€£çºŒEventä¸è¦†è“‹Eventç•¶å¤©ï¼‰
                eventDays.forEach(idx => {
                    // å‰2å¤©è¨­ç‚ºæ”¾å‡ï¼Œä½†ä¸è¦†è“‹Eventç•¶å¤©
                    for (let i = 1; i <= 2; i++) {
                        const restIdx = idx - i;
                        // è‹¥è©²å¤©æœ¬ä¾†å°±æ˜¯Eventï¼Œä¸è¦†è“‹
                        if (restIdx >= 0 && !eventDays.includes(restIdx)) {
                            schedule[daysOfWeek[restIdx]] = 'æ”¾å‡';
                        }
                    }
                    // ç•¶å¤©é¡¯ç¤ºè³½äº‹åç¨± è·é›¢Kï¼ˆè‹¥æœ‰å¤šå€‹Eventï¼Œé¡¯ç¤ºæ‰€æœ‰åç¨±èˆ‡è·é›¢ï¼‰
                    const date = weekDates[idx];
                    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const eventList = (events[dateKey] || []).filter(ev => ev.type === 'Event');
                    if (eventList.length > 0) {
                        // é¡¯ç¤ºæ‰€æœ‰Eventåç¨±èˆ‡è·é›¢
                        schedule[daysOfWeek[idx]] = eventList.map(ev => {
                            let str = ev.name || 'è³½äº‹';
                            if (ev.distance) str += ` ${ev.distance}K`;
                            return str;
                        }).join(' / ');
                    }
                });
                return daysOfWeek.map(day => `${day}: ${schedule[day] || 'No training'}`).join('\n');
            }

            // ä¿å­˜æ¶ˆæ¯åˆ°æ­·å²è¨˜éŒ„
            function saveMessageToHistory(messageText, isUser) {
                const currentUser = getCurrentUser();
                let key = currentUser ? `chatHistory_${currentUser}` : 'chatHistory_guest';
                let chatHistory = JSON.parse(localStorage.getItem(key) || '[]');
                chatHistory.push({
                    text: messageText,
                    isUser: isUser,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem(key, JSON.stringify(chatHistory));
                if (localStorage.getItem('token')) syncToCloud();
            }

            // åŠ è¼‰æ­·å²æ¶ˆæ¯
            function loadChatHistory() {
                const currentUser = getCurrentUser();
                let key = currentUser ? `chatHistory_${currentUser}` : 'chatHistory_guest';
                let chatHistory = [];
                const raw = localStorage.getItem(key);
                if (raw) {
                    chatHistory = JSON.parse(raw);
                }
                if (!raw || chatHistory.length === 0) {
                    // åƒ…åœ¨ localStorage æ²’æœ‰ä»»ä½•ç´€éŒ„æ™‚æ‰é¡¯ç¤ºæ­¡è¿è©ï¼Œä¸¦å¯«å…¥ä¸€ç­†æ­¡è¿è©åˆ° chatHistory
                    const welcomeMessage = `æ­¡è¿ä½¿ç”¨ã€Šä¸‰é …éƒ½æœƒç´¯ã€‹çš„èª²è¡¨ï¼\né€™ä»½è¨“ç·´èª²è¡¨æœƒåœ¨ä½ æ‡·ç–‘äººç”Ÿä¹‹å‰ï¼Œ\nå…ˆè²¼å¿ƒå¹«ä½ å®‰æ’å¥½æ¯é€±è©²æ€éº¼ç´¯å¾—æœ‰æ„ç¾©ã€‚\nè«‹å‹‡æ•¢æŒ‰ä¸‹ã€Œä»Šæ—¥èª²è¡¨ã€æˆ–ã€Œæœ¬é€±èª²è¡¨ã€\näº«å—é€™æ®µéµäººæ—…ç¨‹å§ï¼! !`;
                    addMessageToChat(welcomeMessage, false);
                    // å¯«å…¥æ­¡è¿è©åˆ° chatHistoryï¼Œé¿å…é‡è¤‡é¡¯ç¤º
                    localStorage.setItem(key, JSON.stringify([{ text: welcomeMessage, isUser: false, timestamp: new Date().toISOString() }]));
                } else {
                    chatHistory.forEach(msg => {
                        addMessageToChat(msg.text, msg.isUser);
                    });
                }
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
            function addMessageToChat(messageText, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', isUser ? 'user' : 'bot');
                messageDiv.textContent = messageText;
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // ä¿®æ”¹ addMessageToChat ä»¥è§¸ç™¼å½©è›‹ï¼ˆå¿…é ˆåœ¨ function å®£å‘Šä¹‹å¾Œï¼‰
            (function(){
                const _origAddMessageToChat = addMessageToChat;
                addMessageToChat = function(messageText, isUser) {
                    if (!isUser && window.__egg_check_message) window.__egg_check_message(messageText);
                    _origAddMessageToChat.apply(this, arguments);
                };
            })();

            function saveRunToCalendar(km) {
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'è·‘æ­¥', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token')) syncToCloud();
            }

            function saveBikeToCalendar(km) {
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'é¨è»Š', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token')) syncToCloud();
            }

            function saveSwimToCalendar(km) {
                const currentUser = getCurrentUser();
                const today = new Date();
                const y = today.getFullYear();
                const m = String(today.getMonth() + 1).padStart(2, '0');
                const d = String(today.getDate()).padStart(2, '0');
                const dateKey = `${y}-${m}-${d}`;
                let events;
                if (currentUser) {
                    events = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                } else {
                    events = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
                }
                if (!events[dateKey]) events[dateKey] = [];
                events[dateKey].push({ type: 'æ¸¸æ³³', distance: km, duration: 0 });
                if (currentUser) {
                    localStorage.setItem(`calendarEvents_${currentUser}`, JSON.stringify(events));
                } else {
                    localStorage.setItem('calendarEvents', JSON.stringify(events));
                }
                if (localStorage.getItem('token')) syncToCloud();
            }

            let expectingSwimResponse = false;
            let expectingCyclingResponse = false;
            let expectingRunningResponse = false;

            function getHomeScheduleStatus() {
                // å–å¾—é¦–é èª²è¡¨é¸æ“‡ç‹€æ…‹
                const type = localStorage.getItem('selectedScheduleType') || '';
                const distance = localStorage.getItem('selectedScheduleDistance') || '';
                // åˆ¤æ–·æ˜¯å¦ç‚º Challenge Taiwan/226 æˆ– Ironman/113
                if (!type || !distance) return { status: 'not_selected' };
                if (
                    (type === 'Challenge Taiwan' && distance === '226') ||
                    (type === 'Ironman' && distance === '113')
                ) {
                    // åˆ¤æ–·æ˜¯å¦å€’æ•¸ä¸­
                    let raceDate = null;
                    if (type === 'Challenge Taiwan' && distance === '226') {
                        raceDate = new Date(2026, 3, 25);
                    } else if (type === 'Ironman' && distance === '113') {
                        raceDate = new Date(2025, 10, 2);
                    }
                    if (raceDate) {
                        const startDate = new Date(raceDate);
                        startDate.setDate(raceDate.getDate() - 236);
                        const now = new Date();
                        if (now < startDate) {
                            const diff = startDate - now;
                            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                            return { status: 'countdown', days };
                        }
                    }
                    return { status: 'normal' };
                }
                // å…¶å®ƒèª²è¡¨çš†è¦–ç‚ºç„¡å°æ‡‰å…§å®¹
                return { status: 'not_exist' };
            }

            dailyScheduleButton.addEventListener('click', () => {
                const homeStatus = getHomeScheduleStatus();
                if (homeStatus.status === 'not_selected') {
                    addMessageToChat('å—šå—šï½æˆ‘é‚„æ²’æ”¶åˆ°ä½ çš„èª²è¡¨å•¦ğŸ˜­ æˆ‘ä»€éº¼éƒ½ä¸èƒ½æ•™ä½ æ¬¸ï½å¿«å»é¦–é é¸ä¸€å€‹èª²è¡¨å§ï¼ğŸ™‡â€â™‚ï¸', false);
                    return;
                } else if (homeStatus.status === 'not_exist') {
                    addMessageToChat('ä½ æ‰¾çš„èª²è¡¨é‚„åœ¨å®‡å®™ç”Ÿæˆä¸­ğŸŒŒğŸŒ€ï½å›é¦–é æŒ‘ä¸€å€‹å·²ç¶“å­˜åœ¨çš„èª²è¡¨å§ğŸš€ï¼', false);
                    return;
                } else if (homeStatus.status === 'countdown') {
                    addMessageToChat(`è·é›¢èª²è¡¨é–‹å§‹é‚„æœ‰ ${homeStatus.days} å¤©ï¼`, false);
                    return;
                }
                addMessageToChat(`ä»Šæ—¥èª²è¡¨:\n${getTodaySchedule()}`, false);
            });

            weeklyScheduleButton.addEventListener('click', () => {
                const homeStatus = getHomeScheduleStatus();
                if (homeStatus.status === 'not_selected') {
                    addMessageToChat('å—šå—šï½æˆ‘é‚„æ²’æ”¶åˆ°ä½ çš„èª²è¡¨å•¦ğŸ˜­ æˆ‘ä»€éº¼éƒ½ä¸èƒ½æ•™ä½ æ¬¸ï½å¿«å»é¦–é é¸ä¸€å€‹èª²è¡¨å§ï¼ğŸ™‡â€â™‚ï¸', false);
                    return;
                } else if (homeStatus.status === 'not_exist') {
                    addMessageToChat('ä½ æ‰¾çš„èª²è¡¨é‚„åœ¨å®‡å®™ç”Ÿæˆä¸­ğŸŒŒğŸŒ€ï½å›é¦–é æŒ‘ä¸€å€‹å·²ç¶“å­˜åœ¨çš„èª²è¡¨å§ğŸš€ï¼', false);
                    return;
                } else if (homeStatus.status === 'countdown') {
                    addMessageToChat(`è·é›¢èª²è¡¨é–‹å§‹é‚„æœ‰ ${homeStatus.days} å¤©ï¼`, false);
                    return;
                }
                addMessageToChat(`æœ¬é€±èª²è¡¨:\n${getWeeklySchedule()}`, false);
            });

            swimmingButton.addEventListener('click', () => {
                expectingSwimResponse = true;
                expectingCyclingResponse = false;
                expectingRunningResponse = false;
                addMessageToChat('ä»Šå¤©æ¸¸äº†å¹¾ Kå‘¢?', false);
            });

            cyclingButton.addEventListener('click', () => {
                expectingSwimResponse = false;
                expectingCyclingResponse = true;
                expectingRunningResponse = false;
                addMessageToChat('ä»Šå¤©é¨äº†å¹¾ Kå‘¢?', false);
            });

            runningButton.addEventListener('click', () => {
                expectingSwimResponse = false;
                expectingCyclingResponse = false;
                expectingRunningResponse = true;
                addMessageToChat('ä»Šå¤©è·‘äº†å¹¾ Kå‘¢?', false);
            });

            function handleMessageInput(messageText) {
                if (messageText) {
                    addMessageToChat(messageText, true);
                    messageInput.value = '';
                    
                    if (expectingSwimResponse && /\d|K/i.test(messageText)) {
                        const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                        if (km > 0) {
                            saveSwimToCalendar(km);
                            addMessageToChat(`å˜¿ï½ä»Šå¤©æ¸¸äº† ${km} å…¬é‡Œï¼Œè¾›è‹¦å•¦ï½ğŸ‘ğŸ‘ğŸ‘`, false);
                        } else {
                            addMessageToChat('è«‹è¼¸å…¥æœ‰æ•ˆçš„è·é›¢', false);
                        }
                        expectingSwimResponse = false;
                    }
                    else if (expectingCyclingResponse && /\d|K/i.test(messageText)) {
                        const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                        if (km > 0) {
                            saveBikeToCalendar(km);
                            addMessageToChat(`å˜¿ï½ä»Šå¤©é¨äº† ${km} å…¬é‡Œï¼Œè¾›è‹¦å•¦ï½ğŸ‘ğŸ‘ğŸ‘`, false);
                        } else {
                            addMessageToChat('è«‹è¼¸å…¥æœ‰æ•ˆçš„è·é›¢', false);
                        }
                        expectingCyclingResponse = false;
                    }
                    else if (expectingRunningResponse && /\d|K/i.test(messageText)) {
                        const km = parseFloat(messageText.match(/\d+/)?.[0] || 0);
                        if (km > 0) {
                            saveRunToCalendar(km);
                            addMessageToChat(`å˜¿ï½ä»Šå¤©è·‘äº† ${km} å…¬é‡Œï¼Œè¾›è‹¦å•¦ï½ğŸ‘ğŸ‘ğŸ‘`, false);
                        } else {
                            addMessageToChat('è«‹è¼¸å…¥æœ‰æ•ˆçš„è·é›¢', false);
                        }
                        expectingRunningResponse = false;
                    }
                }
            }

            messageInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleMessageInput(messageInput.value.trim());
                }
            });

            sendButton.addEventListener('click', function() {
                handleMessageInput(messageInput.value.trim());
            });

            // åˆå§‹åŒ–
            loadChatHistory();

            // è¨­ç½®ç•¶å‰é é¢çš„å°èˆªæŒ‰éˆ•ç‚ºæ¿€æ´»ç‹€æ…‹
            const currentPath = window.location.pathname.replace(/^\/+/, '');
            document.querySelectorAll('.nav-button').forEach(button => {
                const href = button.getAttribute('href').replace(/^\/+/, '');
                if (
                    (href === 'index.html' && (currentPath === '' || currentPath.endsWith('index.html')))
                    || (href !== 'index.html' && currentPath.endsWith(href))
                ) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // ====== ç™»å…¥/è¨»å†Š Modal æ§åˆ¶ ======
            function showAuthModal() {
                document.getElementById('auth-modal').style.display = 'flex';
            }
            function hideAuthModal() {
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('auth-error').textContent = '';
            }
            document.getElementById('auth-modal').addEventListener('click', function(e) {
                if (e.target === this) hideAuthModal();
            });

            // ====== ç™»å…¥/è¨»å†Š/åŒæ­¥ API ======
            async function login(username, password) {
                const res = await fetch(`${window.location.origin}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('currentUser', username);
                    await syncFromCloud();
                    hideAuthModal();
                    location.reload();
                } else {
                    document.getElementById('auth-error').textContent = data.error || 'ç™»å…¥å¤±æ•—';
                }
            }
            async function register(username, password) {
                const res = await fetch(`${window.location.origin}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (res.ok) {
                    await login(username, password);
                } else {
                    document.getElementById('auth-error').textContent = 'è¨»å†Šå¤±æ•—';
                    // æ–°å¢ï¼šè¨»å†Šå¤±æ•—æ™‚é¡¯ç¤ºå½©è›‹è¨Šæ¯
                    if (window.__egg_check_message) window.__egg_check_message('è¾›è‹¦å•¦ï½');
                    addMessageToChat('è¾›è‹¦å•¦ï½', false);
                }
            }
            async function syncFromCloud() {
                const token = localStorage.getItem('token');
                if (!token) return;
                const res = await fetch(`${window.location.origin}/api/data`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('currentUser');
                    alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    window.location.href = '../membership/membership.html';
                    return;
                }
                const { data } = await res.json();
                if (data) {
                    Object.keys(data).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(data[key]));
                    });
                }
                // ä¸å†è‡ªå‹•å‘¼å« loadChatHistoryï¼Œé¿å…é‡è¤‡é¡¯ç¤ºé–‹å ´ç™½
            }
            async function syncToCloud() {
                const token = localStorage.getItem('token');
                if (!token) return;
                // æ”¶é›†æ‰€æœ‰ä½ æƒ³åŒæ­¥çš„ localStorage è³‡æ–™
                const currentUser = getCurrentUser();
                const chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${currentUser}`) || '[]');
                const calendarEvents = JSON.parse(localStorage.getItem(`calendarEvents_${currentUser}`) || '{}');
                await fetch(`${window.location.origin}/api/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ data: {
                        [`chatHistory_${currentUser}`]: chatHistory,
                        [`calendarEvents_${currentUser}`]: calendarEvents
                    }})
                });
            }

            // ====== ç¶å®šç™»å…¥/è¨»å†ŠæŒ‰éˆ• ======
            document.getElementById('login-btn').onclick = function() {
                const u = document.getElementById('auth-username').value.trim();
                const p = document.getElementById('auth-password').value.trim();
                if (u && p) login(u, p);
            };
            document.getElementById('register-btn').onclick = function() {
                const u = document.getElementById('auth-username').value.trim();
                const p = document.getElementById('auth-password').value.trim();
                if (u && p) register(u, p);
            };

            // ====== è‡ªå‹•åŒæ­¥ï¼šæ¯æ¬¡è³‡æ–™è®Šå‹•æ™‚å‘¼å« syncToCloud() ======
            // ä¾‹å¦‚ä½ åœ¨ saveMessageToHistory/saveRunToCalendar/saveBikeToCalendar/saveSwimToCalendar è£¡åŠ ä¸Š
            // if (localStorage.getItem('token')) syncToCloud();

            // ====== é¦–æ¬¡è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹ ======
            window.addEventListener('DOMContentLoaded', function() {
                // å¦‚æœæœ‰ token å°±è‡ªå‹•åŒæ­¥é›²ç«¯è³‡æ–™
                if (localStorage.getItem('token')) {
                    syncFromCloud();
                    setInterval(() => {
                        syncFromCloud();
                    }, 10000); // æ¯ 10 ç§’è‡ªå‹•åŒæ­¥ä¸€æ¬¡
                }
                // ä½ å¯ä»¥åœ¨é€™è£¡åŠ ä¸€å€‹ã€Œç™»å…¥ã€æŒ‰éˆ•ï¼Œæˆ–åœ¨æœƒå“¡é åŠ ã€Œç™»å‡ºã€åŠŸèƒ½
                // å¦‚æœæƒ³å¼·åˆ¶ç”¨æˆ¶ç™»å…¥æ‰ç”¨åŒæ­¥åŠŸèƒ½ï¼Œå¯åœ¨é€™è£¡ showAuthModal()
            });

            // ====== å½©è›‹èˆ‡ç…™ç«ç‰¹æ•ˆ ======
            (function(){
                const EGG_KEY = 'chat_v5_easter_eggs';
                const EGG_MESSAGES = [
                    'ä½ æ‰¾çš„èª²è¡¨é‚„åœ¨å®‡å®™ç”Ÿæˆä¸­ğŸŒŒğŸŒ€ï½å›é¦–é æŒ‘ä¸€å€‹å·²ç¶“å­˜åœ¨çš„èª²è¡¨å§ğŸš€ï¼',
                    /è¾›è‹¦å•¦ï½/
                ];
                let eggState = JSON.parse(localStorage.getItem(EGG_KEY) || '{}');
                if (typeof eggState !== 'object' || !eggState) eggState = {};
                function showFireworksOrRocket(isRocket) {
                    if (document.getElementById('egg-fireworks-overlay')) return;
                    const overlay = document.createElement('div');
                    overlay.id = 'egg-fireworks-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.left = 0;
                    overlay.style.top = 0;
                    overlay.style.width = '100vw';
                    overlay.style.height = '100vh';
                    overlay.style.zIndex = 99999;
                    overlay.style.pointerEvents = 'none';
                    overlay.style.background = 'rgba(0,0,0,0.10)';
                    overlay.innerHTML = `
                        <canvas id="egg-fireworks-canvas" style="position:absolute;left:0;top:0;width:100vw;height:100vh;pointer-events:none;"></canvas>
                        <div id="egg-popup" style="position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.97);border-radius:22px;padding:38px 36px 32px 36px;box-shadow:0 8px 32px rgba(0,0,0,0.18);font-size:2rem;color:#222;display:flex;flex-direction:column;align-items:center;gap:18px;">
                            <div style="font-size:2.5rem;">ğŸ¥šğŸ‰</div>
                            <div id="egg-popup-title" style="font-weight:bold;font-size:2rem;">æ¡è›‹æˆåŠŸï¼</div>
                            <div id="egg-popup-desc" style="font-size:1.2rem;color:#00bcd4;"></div>
                        </div>
                        <div id="egg-rocket" style="display:none;position:absolute;left:50%;top:60%;transform:translate(-50%,-50%);font-size:120px;">ğŸš€</div>
                    `;
                    document.body.appendChild(overlay);
                    const canvas = document.getElementById('egg-fireworks-canvas');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    // Fireworks animation
                    let ctx = canvas.getContext('2d');
                    let particles = [];
                    function randomColor() {
                        return `hsl(${Math.random()*360},100%,60%)`;
                    }
                    function createFirework() {
                        const x = Math.random()*canvas.width*0.8+canvas.width*0.1;
                        const y = Math.random()*canvas.height*0.5+canvas.height*0.1;
                        const count = 24+Math.floor(Math.random()*12);
                        for(let i=0;i<count;i++){
                            const angle = (Math.PI*2)*i/count;
                            const speed = 2+Math.random()*2;
                            particles.push({
                                x,y,
                                vx: Math.cos(angle)*speed,
                                vy: Math.sin(angle)*speed,
                                alpha: 1,
                                color: randomColor(),
                                size: 2+Math.random()*2
                            });
                        }
                    }
                    let fireworkTimer = 0;
                    function animate() {
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        if (isRocket) {
                            document.getElementById('egg-rocket').style.display = 'block';
                            document.getElementById('egg-popup-title').textContent = 'å½©è›‹å…¨æ”¶é›†ï¼';
                            document.getElementById('egg-popup-desc').textContent = 'ğŸš€ ç«ç®­å‡ç©ºï¼';
                            document.getElementById('egg-popup').style.background = 'rgba(255,255,255,0.98)';
                        } else {
                            document.getElementById('egg-rocket').style.display = 'none';
                            if (fireworkTimer++%10===0) createFirework();
                        }
                        particles.forEach(p => {
                            ctx.globalAlpha = p.alpha;
                            ctx.beginPath();
                            ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
                            ctx.fillStyle = p.color;
                            ctx.fill();
                            p.x += p.vx;
                            p.y += p.vy;
                            p.vx *= 0.96;
                            p.vy *= 0.96;
                            p.alpha *= 0.96;
                        });
                        particles = particles.filter(p=>p.alpha>0.05);
                        if (document.getElementById('egg-fireworks-overlay'))
                            requestAnimationFrame(animate);
                    }
                    animate();
                    setTimeout(()=>{
                        overlay.remove();
                        if (isRocket) {
                            eggState.__rocketShown = true;
                            localStorage.setItem(EGG_KEY, JSON.stringify(eggState));
                        }
                    },7000);
                }
                // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥æ˜¯å¦é›†æ»¿3å€‹å½©è›‹ï¼Œè‹¥æœ‰ä¸”ç«ç®­æœªé¡¯ç¤ºéå‰‡é¡¯ç¤ºç«ç®­
                document.addEventListener('DOMContentLoaded', function() {
                    let eggState = JSON.parse(localStorage.getItem(EGG_KEY) || '{}');
                    let count = Object.keys(eggState).filter(k=>k!=="__showRocket" && k!=="__rocketShown").length;
                    if (count===3 && !eggState.__rocketShown) {
                        setTimeout(()=>showFireworksOrRocket(true), 300);
                    }
                });
                window.__egg_check_message = function(msg) {
                    let matched = false;
                    for(let i=0;i<EGG_MESSAGES.length;i++){
                        const rule = EGG_MESSAGES[i];
                        if (typeof rule==="string" && msg===rule) matched = rule;
                        if (rule instanceof RegExp && rule.test && rule.test(msg)) matched = rule.toString();
                    }
                    // æ–°å¢ï¼šè‹¥è¨Šæ¯ç‚ºã€Œä»Šæ—¥èª²è¡¨:\næ”¾å‡ã€æˆ–ã€Œä»Šæ—¥èª²è¡¨:\n\næ”¾å‡ã€ä¹Ÿç®—ä¸€å€‹å½©è›‹
                    if (/^ä»Šæ—¥èª²è¡¨:\n{1,2}æ”¾å‡$/.test(msg) && !eggState['DAILY_HOLIDAY']) {
                        matched = 'DAILY_HOLIDAY';
                    }
                    if (matched && !eggState[matched]) {
                        eggState[matched] = 1;
                        localStorage.setItem(EGG_KEY, JSON.stringify(eggState));
                        showFireworksOrRocket(false);
                    }
                    // æª¢æŸ¥æ˜¯å¦é›†æ»¿3å€‹ï¼Œä¸”ç«ç®­æœªé¡¯ç¤ºé
                    let count = Object.keys(eggState).filter(k=>k!=="__showRocket" && k!=="__rocketShown").length;
                    if (count===3 && !eggState.__rocketShown) {
                        setTimeout(()=>showFireworksOrRocket(true), 300);
                    }
                };
            })();

            // ====== å½©è›‹é‡ç½®åŠŸèƒ½ ======
            window.resetEggs = function() {
                localStorage.removeItem('chat_v5_easter_eggs');
                alert('å½©è›‹å·²é‡ç½®ï¼');
            };
        });
    </script>
</body>
</html>